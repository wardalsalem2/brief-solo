document
  .getElementById("burger-menu-btn")
  .addEventListener("click", function () {
    document.getElementById("sidebar").classList.toggle("active");
  });

window.addEventListener("click", function (event) {
  const sidebar = document.getElementById("sidebar");
  const burgerMenuBtn = document.getElementById("burger-menu-btn");
  if (
    !sidebar.contains(event.target) &&
    !burgerMenuBtn.contains(event.target)
  ) {
    sidebar.classList.remove("active");
  }
});

window.addEventListener("scroll", function () {
  const navbar = document.querySelector("header");
  navbar.classList.toggle("sticky", window.scrollY > 0);
});

document.querySelectorAll("#username, #profile-photo").forEach((element) => {
  element.addEventListener("click", function () {
    const dropdownMenu = document.getElementById("dropdown-menu");
    dropdownMenu.style.display =
      dropdownMenu.style.display === "none" ? "block" : "none";
  });
});

window.addEventListener("click", function (event) {
  const dropdownMenu = document.getElementById("dropdown-menu");
  const username = document.getElementById("username");
  const profilePhoto = document.getElementById("profile-photo");
  if (
    !dropdownMenu.contains(event.target) &&
    !username.contains(event.target) &&
    !profilePhoto.contains(event.target)
  ) {
    dropdownMenu.style.display = "none";
  }
});

const userSession = JSON.parse(sessionStorage.getItem("userSession") || "{}");
const loggedIn = userSession.loggedIn || false;

if (!loggedIn) {
  alert("Unauthorized access detected. You have been banned permanently.");
  localStorage.setItem("banned", "true");
  window.location.href = "01-Welcome-Page.html";
}

const username =
  userSession.username.charAt(0).toUpperCase() + userSession.username.slice(1);
document.querySelectorAll("#username").forEach((element) => {
  element.textContent = username;
});

const topic =
  userSession.topic.charAt(0).toUpperCase() + userSession.topic.slice(1);
document.getElementById("quiz-topic").textContent = topic;

const selectedQuestions = userSession.selectedQuestions;
let currentQuestionIndex = 0;
let userAnswers = [];
let questionStartTime = Date.now();

function loadQuestion(index) {
  const questionData = selectedQuestions[index];
  document.querySelector(".qs-num").textContent = index + 1;
  document.querySelector(".question-text").textContent = questionData.question;
  const answersContainer = document.querySelector(".answers-container");
  answersContainer.innerHTML = "";
  questionData.answers.forEach((answer, i) => {
    const answerOption = document.createElement("label");
    answerOption.classList.add("answer-option");
    answerOption.innerHTML = `
      <input type="radio" name="answer" value="${answer}" />
      <span class="answer-circle">${String.fromCharCode(65 + i)}</span>
      <span class="answer-text">${answer}</span>
    `;
    answersContainer.appendChild(answerOption);
  });
  document.getElementById("next-btn").disabled = true;
  document.getElementById("next-btn").textContent =
    index === selectedQuestions.length - 1 ? "Submit" : "Next";
  questionStartTime = Date.now();
}

loadQuestion(currentQuestionIndex);

document
  .querySelector(".answers-container")
  .addEventListener("change", function () {
    document.getElementById("next-btn").disabled = false;
  });

document.getElementById("next-btn").addEventListener("click", function () {
  const selectedAnswer = document.querySelector(
    'input[name="answer"]:checked'
  ).value;
  const questionData = selectedQuestions[currentQuestionIndex];
  const userCorrect = selectedAnswer === questionData.correctAnswer;
  const timeTook = (Date.now() - questionStartTime) / 1000; // Time in seconds
  userAnswers.push({
    attemptID: Date.now(),
    quizQuestion: currentQuestionIndex + 1,
    questionID: questionData.questionId,
    question: questionData.question,
    correct: questionData.correctAnswer,
    userAnswer: selectedAnswer,
    timeTook: timeTook,
    userCorrect: userCorrect,
  });
  if (currentQuestionIndex < selectedQuestions.length - 1) {
    currentQuestionIndex++;
    loadQuestion(currentQuestionIndex);
  } else {
    userSession.userAnswers = userAnswers;
    sessionStorage.setItem("userSession", JSON.stringify(userSession));
    window.location.href = "06-Result-Report-Page.html";
  }
});

document.getElementById("logout-link").addEventListener("click", function () {
  sessionStorage.removeItem("userSession");
  sessionStorage.removeItem("loggedIn");
  sessionStorage.removeItem("fromWelcomePage");
  sessionStorage.removeItem("fromSignupPage");
  window.location.href = "01-Welcome-Page.html";
});

let timerInterval;
let timeLeft = 300; // 5 minutes in seconds

function startTimer() {
  timerInterval = setInterval(function () {
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      alert("Time's up!");
      window.location.href = "06-Result-Report-Page.html";
    } else {
      timeLeft--;
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      document.getElementById("timer-box").textContent = `${minutes}:${
        seconds < 10 ? "0" : ""
      }${seconds}`;
    }
  }, 1000);
}

document.getElementById("timer-icon").addEventListener("click", function () {
  const timerBox = document.getElementById("timer-box");
  timerBox.style.display = timerBox.style.display === "none" ? "block" : "none";
});

startTimer();
